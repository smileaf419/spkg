####
## gmp build
## Copyright 2023 spkg developers, licensed under GPLv2
HOMEPAGE="https://www.gnu.org/software/gmp/"
DESCRIPTION=""
LICENSE=""
SRC_URI=("https://ftp.gnu.org/gnu/gmp/gmp-${PKG_VER}.tar.xz")
[[ $VERIFY_SIG == 1 ]] && SRC_URI+=("https://ftp.gnu.org/gnu/gmp/gmp-${PKG_VER}.tar.xz.sig")
DEPS=""
BDEPS=""
RDEPS=""
ARCHS="x86 x86_64"
SLOT=0
ABILIBS="64 x32 32"
_SPKG_CLEAN=distclean

src_configure() {
	if [[ $ABILIB != 64 ]]; then
		cp -v configfsf.guess config.guess
		cp -v configfsf.sub   config.sub
		## Don't set CONF_FLAGS as it'll override --prefix and others we want.
		SET_ABI="ABI=$ABILIB"
		local arch=x86-64
		filter-flags -march
		append-cflags -m$ABILIB -O2 -pedantic -fomit-frame-pointer -mtune=generic -march=$arch
		CONF_FLAGS="--prefix=/usr --disable-static --includedir=/usr/include/m$ABILIB/gmp"
		export CXXFLAGS=$CFLAGS
		export PKG_CONFIG_PATH="/usr/lib$ABILIB/pkgconfig"
		export CPPFLAGS=
	fi
	configure_default --enable-cxx --libdir=/lib$ABILIB

	[[ $ABILIB != 64 ]] && sed 's/$(exec_prefix)\/include/$\(includedir\)/' -i Makefile || true
}

src_compile() {
	compile_default

	## Only build/install this once
	## bootstrap sets a ABILIB=64 where-as non-bootstrap sets ABILIB=
	[[ $ABILIB == 64 ]] && make html || true
}

src_test() {
	make check 2>&1 | tee gmp-check-log
	TEST=$(awk '/# PASS:/{total+=$3} ; END{print total}' gmp-check-log)
#	[ $TEST != 197 ] && die "Passing tests: ${TEST} != 197"
}

src_install() {
	if [[ $ABILIB == 64 ]]; then
		install_default
		make DESTDIR="$ROOT/${D}" install-html
	else
		make DESTDIR=$PWD/DESTDIR install
		mkdir -p $D/lib$ABILIB
		mkdir -p $D/usr/include/m$ABILIB
		cp -Rv DESTDIR/lib$ABILIB/* $D/lib$ABILIB
		cp -Rv DESTDIR/usr/include/m$ABILIB/* $D/usr/include/m$ABILIB/
		rm -rf DESTDIR
	fi
}

bootstrap() {
	case $PKG_FLAGS in
		pass1)
			CONF_FLAGS="--build=$(./config.guess) --prefix=/tools"
			src_configure
			compile_default
			install_default
			;;
		*)
			for ABILIB in $ABILIBS; do
				CONF_FLAGS=
				if [[ $ABILIB != 64 ]]; then
					make distclean
				else
					ABILIB=
				fi
				export PKG_CONFIG_PATH="/usr/lib$ABILIB/pkgconfig"

				src_configure
				compile_default
				install_default
			done
			;;
		esac
}
