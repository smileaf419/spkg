####
## libcap build
## Copyright 2023 spkg developers, licensed under GPLv2
HOMEPAGE="https://sites.google.com/site/fullycapable/"
DESCRIPTION="POSIX 1003.1e capabilities"
LICENSE="GPLv2 BSD"
SRC_URI="https://www.kernel.org/pub/linux/libs/security/linux-privs/libcap2/libcap-${PKG_VER}.tar.xz"
DEPS=""
BDEPS=""
RDEPS=""
ARCHS="x86 x86_64"
SLOT=0
TEST=test
ABILIBS="64 x32 32"

src_configure() {
	## Prevent static libraries from being installed
	sed -i '/install -m.*STA/d' libcap/Makefile

	## Fix install locations.
	sed -e '/^exec_prefix/ s,$(prefix),/,' \
		-e '/^inc_prefix/ s,lib_,,' \
		-i Make.Rules
}

src_compile() {
	if [[ $ABILIB == 64 ]]; then
		compile_default prefix=/usr lib=lib
	else
		local arch=x86_64
		[[ $ABILIB == 32 ]] && arch=i686
		export CC="gcc -m$ABILIB -march=$arch"
		compile_default
	fi
}

src_install() {
	if [[ $ABILIB == 64 ]]; then
		install_default prefix="/usr" lib=lib
	else
		local arch=x86_64
		[[ $ABILIB == 32 ]] && arch=i686
		export CC="gcc -m$ABILIB -march=$arch"
		install_default lib=lib$ABILIB prefix=$PWD/DESTDIR/usr -C libcap
		mkdir -p $D/usr/lib$ABILIB
		cp -Rv DESTDIR/usr/lib$ABILIB/* $D/usr/lib$ABILIB
		sed -e "s|^libdir=.*|libdir=/usr/lib$ABILIB|" -i $D/usr/lib$ABILIB/pkgconfig/lib{cap,psx}.pc
		chmod -v 755 $D/usr/lib$ABILIB/libcap.so.$PKG_VER
		rm -rf DESTDIR
	fi
#	install -v -m755 pam_cap/pam_cap.so "${D}/usr/lib/security"
#	mkdir -p "${D}/etc/security"
#	install -v -m644 pam_cap/capability.conf "${D}/etc/security"
}
