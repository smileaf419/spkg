#!/bin/bash
####
## Defines functions not organized/categorized into other files

## Create an archive package of our build, could be useful if we decide to distribute binary copies
## Enabled with BUILD_PACKAGE = yes
archivePackage() {
	# Package it up
	if [[ $BUILD_PACKAGE == "yes" && $ARCHIVE_INSTALL != 1 && $MODE != "bootstrap" ]]; then
		echo -n "Packaging up..."
		mkdir -p "${PKG_ARCHIVE_DIR}/${PKG_CAT}"
		tar -Jcpf "${PKG_ARCHIVE_DIR}/${PKG_CAT}/${PKG_NAME}-${PKG_VR}.tar.xz" . && echo " Done"
	fi
}

## Remove unneccessary symbols to reduce the filesize in binaries.
## Packages may disable this with RESTRICT=strip
stripPackage() {
	pkg-restricts strip && return
	cd "${D}"
	echo "Stripping..."
	for s in $( find . -iwholename "*bin/*" -or -iwholename "*/lib*" ); do
		strip --strip-unneeded "$s" 2> /dev/null && echo " -- $s"
	done
}

## Find all binary dependencies
## Packages may disable this with RESTRICT=nobin
getBDeps() {
	pkg-restricts nobin && return
	echo -n "Finding Binary Dependencies..."
	for dep in $( cat $1 | grep -P 'bin/|/lib/|/lib64/|/lib32/|/libx32/'); do
		deps=$(readelf -d $dep 2> /dev/null | grep NEEDED | sed -e 's,.*\[\(.*\)\].*,\1,')
		for d in $deps; do
			for p in $(cat /etc/ld.so.conf); do
				[ -e $p/$d ] && echo $p/$d
			done
		done
	done | sort | uniq > "${PKG_CACHE}/$PKG_CAT/$PKG_NAME/$PKG_VER/BDEPS"
	echo "Done"
}

####
## Takes a list of LENTRY to (un)install
installList() {
	list=($@)
	length=${#list[@]}
	for (( l=0; l<${length}; l++ ));
	do
		## Current #
		C=$(( ${l} + 1 ))
		## PKG entry
		p=${list[$l]}
		setPkgENV $p
		setupENV $p

		## Uninstall
		if [[ $MODE == "uninstall" ]]; then
			echo "Uninstalling ${PKG_CAT}/$PKG_NAME : $O_VER ($C of $length)"
			(
				source "${PKG_CACHE}/${PKG_CAT}/${PKG_NAME}/${PKG_VER}/${PKG_VER}.build"
				d=$(isDependedOn ${PKG_CAT}/$PKG_NAME $O_VER)

				## FIXME: If uninstalling will break packages Check Forced.
				## Option 1: Uninstall just the requested, breaking other installed packages.
				## Option 2: Uninstall all packages that would break, and any that would break if they were removed.
				## Option 3: Create a Minimal System Requirements package set and disallow any in that list from being
				##           removed under any circumstances.
				if [[ $d != *$p && $d != "" && $FORCE == 0 ]]; then
					echo "Uninstalling will break packages!"
					echo $d
				else
					## pre-uninstall code if needed/set
					uninstall_default
					## Uninstall the package
					uninstall "${PKG_CAT}/${PKG_NAME}" $O_VER ""
					## post-uninstall code if needed/set
					src_post_uninstall
				fi
			)

		## Install
		else
			####
			## Set the log file
			## Can alter this to use a LOGFILE using
			## %c category  %d day   %D date (%Y%m%d)  %s Unix Timestamp
			## %n name      %Y year  %m month          %v version with revision
			LOGFILE=${LOGFILE:-%D-%n%v%r.log}

			LOG=$(echo $LOGDIR/$LOGFILE |
				sed -e "s,%c,$PKG_CAT," \
					-e "s,%n,$PKG_NAME," \
					-e "s,%v,$PKG_VR,"    \
					-e "s,%s,$(date +%s)," \
					-e "s,%d,$(date +%d)," \
					-e "s,%m,$(date +%m)," \
					-e "s,%Y,$(date +%Y)," \
					-e "s,%D,$(date +%Y%m%d),")

			## Our LOG may contain a directory or 2
			mkdir -p "${LOG%/*}"

			## If the file exists, append a unix timestamp to the end.
			[[ -e $LOG || -e $LOG.xz ]] && LOG="${LOG%.*}-$(date +%s).log"

			CFG_PROTECT=true

			export RESTRICT=

			echo " * ${PKG_CAT}/${PKG_NVR} ($C of $length)"

			## Save what time we started installing so we can output how long it took at the end.
			TIMESTART=$(date "+%s.%N")

			if [[ $SILENT_BUILD == "no" ]]; then
				set -o pipefail
				installPackage 2>&1 | tee $LOG
				[ $PIPESTATUS != 0 ] && die "Error installing package: ${PKG_NVR}"
			else
				installPackage > $LOG 2>&1 || die "Error installing package: ${PKG_NVR}"
			fi

			## If bc is installed output how long it took to build
			if [[ -e /usr/bin/bc ]]; then
				printf "Completed in %.3f seconds.\n" $( echo $(date "+%s.%N") - $TIMESTART | bc ) | tee -a $LOG
			fi

			## Compress our log.
			[[ ! -e "${LOG}.xz" ]] && xz "$LOG" || echo " ! Log ${LOG}.xz exists"
		fi
		echo -n " * Running ldconfig .."
		ldconfig && echo "done!" || echo "failed!"
	done
}
